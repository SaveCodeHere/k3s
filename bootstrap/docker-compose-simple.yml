services:
  traefik:
    image: traefik:v3.4.3
    container_name: traefik
    restart: unless-stopped
    command:     
      - --configfile=/etc/traefik/traefik.yml
    ports:
      - "8080:8080"
      - "8081:8081"
      - "8443:8443"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./configs/traefik/traefik.yml:/etc/traefik/traefik.yml:ro
    networks:
      - foundation_network

  vault:
    image: hashicorp/vault:1.16
    container_name: vault
    restart: unless-stopped
    command: vault server -config=/vault/config/vault.hcl
    ports:
      - "8200:8200/tcp"
    environment:
      - VAULT_ADDR=http://0.0.0.0:8200
    cap_add:
      - IPC_LOCK
    volumes:
      - ./configs/vault:/vault/config
      - /data/foundation/vault/data:/vault/data
      - /data/foundation/vault/logs:/vault/logs
    networks:
      - foundation_network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.vault.rule=Host(`vault.um.tail16ca22.ts.net`)"
      - "traefik.http.routers.vault.entrypoints=alt-web"
      - "traefik.http.routers.vault.service=vault-svc"
      - "traefik.http.services.vault-svc.loadbalancer.server.port=8200"

  tailscale:
    image: tailscale/tailscale:v1.66.4
    container_name: tailscale
    restart: unless-stopped
    hostname: nicstack
    environment:
      - TS_AUTHKEY=${TS_AUTHKEY:-}
      - TS_STATE_DIR=/var/lib/tailscale
      - TS_USERSPACE=false
      - TS_SERVE_CONFIG=/config/serve.json
    volumes:
      - /data/foundation/tailscale:/var/lib/tailscale
      - /dev/net/tun:/dev/net/tun
      - ./configs/tailscale:/config
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    sysctls:
      - net.ipv4.ip_forward=1
      - net.ipv6.conf.all.forwarding=1
    networks:
      - foundation_network
    ports:
      - "443:443"
      - "80:80"

networks:
  foundation_network:
    name: foundation_network
    driver: bridge
